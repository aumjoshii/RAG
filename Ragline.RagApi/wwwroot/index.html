<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ragline ‚Äî Local RAG</title>
  <style>
    :root{
      --bg:#0b0f19;
      --panel:#11182a;
      --panel2:#0f1526;
      --text:#e9eefc;
      --muted:#a7b3d6;
      --border:#24304d;
      --accent:#7c5cff;
      --accent2:#00d4ff;
      --good:#2ee59d;
      --warn:#ffcf5a;
      --bad:#ff5c7a;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 700px at 15% 10%, rgba(124,92,255,.18), transparent 55%),
                  radial-gradient(900px 600px at 90% 15%, rgba(0,212,255,.12), transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    .container{
      max-width:1100px;
      margin:0 auto;
      padding:28px 18px 60px;
    }
    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      margin-bottom:18px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .title{
      font-size:28px;
      font-weight:800;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pill{
      font-size:12px;
      padding:4px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      color:var(--muted);
      background: rgba(17,24,42,.6);
    }
    .subtitle{
      color:var(--muted);
      font-size:14px;
      line-height:1.45;
      max-width:720px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(17,24,42,.95), rgba(15,21,38,.95));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-header{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(36,48,77,.6);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .card-title{
      font-weight:750;
      font-size:14px;
      letter-spacing:.25px;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .card-body{
      padding:14px;
    }

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .spacer{flex:1}

    button{
      appearance:none;
      border:1px solid rgba(124,92,255,.45);
      background: linear-gradient(180deg, rgba(124,92,255,.95), rgba(124,92,255,.72));
      color:white;
      padding:10px 12px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      transition: transform .06s ease, filter .2s ease, opacity .2s ease;
      box-shadow: 0 10px 20px rgba(124,92,255,.18);
    }
    button:hover{filter:brightness(1.05)}
    button:active{transform: translateY(1px)}
    button.secondary{
      background: transparent;
      border:1px solid var(--border);
      color:var(--text);
      box-shadow:none;
    }
    button.ghost{
      background: rgba(255,255,255,.03);
      border:1px dashed rgba(167,179,214,.35);
      color:var(--muted);
      box-shadow:none;
    }
    button:disabled{
      opacity:.6;
      cursor:not-allowed;
      transform:none;
    }

    input[type="file"]{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--muted);
    }
    textarea{
      width:100%;
      min-height:120px;
      resize: vertical;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
      line-height:1.5;
      font-size:14px;
    }
    textarea::placeholder{color:rgba(167,179,214,.65)}
    .hint{color:var(--muted); font-size:12px; margin-top:8px; line-height:1.45}

    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(36,48,77,.6);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-family: var(--mono);
      font-size:12px;
      white-space: pre-wrap;
    }

    .mono{
      font-family: var(--mono);
      font-size:12px;
      color:var(--muted);
      white-space: pre-wrap;
      word-break: break-word;
      line-height:1.45;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(36,48,77,.6);
      border-radius:12px;
      padding:12px;
      max-height:280px;
      overflow:auto;
    }

    .answer{
      font-size:14px;
      line-height:1.55;
      color:var(--text);
      background: rgba(0,0,0,.18);
      border:1px solid rgba(36,48,77,.6);
      border-radius:12px;
      padding:12px;
      white-space: pre-wrap;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(36,48,77,.7);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12px;
      font-family: var(--mono);
    }
    .dot{
      width:9px;
      height:9px;
      border-radius:50%;
      background: var(--warn);
      box-shadow: 0 0 0 3px rgba(255,207,90,.12);
    }
    .dot.good{background:var(--good); box-shadow:0 0 0 3px rgba(46,229,157,.12)}
    .dot.bad{background:var(--bad); box-shadow:0 0 0 3px rgba(255,92,122,.12)}

    details{
      border:1px solid rgba(36,48,77,.6);
      border-radius:12px;
      background: rgba(0,0,0,.16);
      padding:10px 12px;
    }
    summary{
      cursor:pointer;
      font-weight:700;
      color:var(--text);
      list-style:none;
    }
    summary::-webkit-details-marker{display:none}
    .sources{
      margin-top:10px;
      font-family: var(--mono);
      font-size:12px;
      color:var(--muted);
      white-space: pre-wrap;
      word-break: break-word;
      line-height:1.45;
    }

    .top-actions{
      display:flex;
      gap:10px;
      align-items:center;
    }

    a{color:inherit}
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="title">
          Ragline <span class="pill">Local RAG</span>
        </div>
        <div class="subtitle">
          Upload documents, ask questions, and get grounded answers with source snippets.
          Runs locally with .NET + embeddings service + Ollama.
        </div>
      </div>

      <div class="top-actions">
        <button class="secondary" onclick="loadDocs()">Refresh docs</button>
        <span class="pill" id="apiState">API: unknown</span>
      </div>
    </header>

    <div class="grid">
      <!-- Left: Documents + Upload -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">üìÑ Indexed documents</div>
          <span class="pill" id="docCount">0</span>
        </div>
        <div class="card-body">
          <div class="mono" id="docs">(click ‚ÄúRefresh docs‚Äù)</div>

          <div style="height:14px"></div>

          <div class="card-title">‚¨ÜÔ∏è Upload</div>
          <div class="hint">Supported: .txt and .pdf</div>
          <div style="height:10px"></div>

          <input id="file" type="file" />
          <div style="height:10px"></div>

          <div class="row">
            <button id="uploadBtn" onclick="upload()">Upload & index</button>
            <button class="ghost" onclick="clearStatus()">Clear status</button>
            <div class="spacer"></div>
          </div>

          <div class="status" id="uploadStatus">Ready.</div>
        </div>
      </div>

      <!-- Right: Ask + Answer -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">üí¨ Ask</div>
          <span class="badge" id="confBadge">
            <span class="dot" id="confDot"></span>
            <span id="confText">confidence: ‚Äî</span>
          </span>
        </div>
        <div class="card-body">
          <textarea id="q" placeholder="Ask something like: ‚ÄúSummarize this resume in 3 bullets‚Äù or ‚ÄúWhat technologies are mentioned?‚Äù"></textarea>

          <div style="height:10px"></div>
          <div class="row">
            <button id="askBtn" onclick="ask()">Ask</button>
            <button class="secondary" onclick="fillExample()">Example question</button>
            <div class="spacer"></div>
            <button class="ghost" onclick="clearAnswer()">Clear</button>
          </div>

          <div style="height:12px"></div>

          <div class="card-title">‚úÖ Answer</div>
          <div style="height:10px"></div>
          <div class="answer" id="ans"></div>

          <div style="height:12px"></div>

          <details>
            <summary>Sources (top matches)</summary>
            <div class="sources" id="src"></div>
          </details>
        </div>
      </div>
    </div>
  </div>

<script>
  const el = (id) => document.getElementById(id);

  function setApiState(ok) {
    el('apiState').innerText = ok ? 'API: healthy' : 'API: not reachable';
  }

  function setConfidence(bestScore, weakMatch) {
    const score = Number(bestScore ?? 0);
    const weak = (weakMatch === true);

    el('confText').innerText = `confidence: ${score.toFixed(3)}${weak ? ' (weak match)' : ''}`;

    const dot = el('confDot');
    dot.classList.remove('good', 'bad');

    if (score >= 0.22 && !weak) dot.classList.add('good');
    else if (score < 0.14) dot.classList.add('bad');
    // else default warn color
  }

  function clearStatus() {
    el('uploadStatus').innerText = 'Ready.';
  }
  function clearAnswer() {
    el('ans').innerText = '';
    el('src').innerText = '';
    setConfidence(null, null);
  }
  function fillExample() {
    el('q').value = 'Summarize the uploaded document in 3 bullet points and list technologies mentioned.';
  }

  async function health() {
    try {
      const r = await fetch('/health');
      setApiState(r.ok);
    } catch {
      setApiState(false);
    }
  }

  async function loadDocs() {
    try {
      const r = await fetch('/documents');
      const j = await r.json();
      el('docCount').innerText = (j || []).length;

      el('docs').innerText = (j || []).map(d =>
        `id=${d.id}\nfile=${d.fileName}\ncreatedUtc=${d.createdUtc}\n`
      ).join('\n---\n') || '(no documents yet)';
    } catch (e) {
      el('docs').innerText = 'Failed to load documents. Is the API running?';
    }
  }

  async function upload() {
    const f = el('file').files[0];
    if (!f) {
      el('uploadStatus').innerText = 'Please choose a file first.';
      return;
    }

    const fd = new FormData();
    fd.append('file', f);

    el('uploadBtn').disabled = true;
    el('uploadStatus').innerText = 'Uploading & indexing...';

    try {
      const r = await fetch('/documents', { method:'POST', body: fd });
      const txt = await r.text();
      el('uploadStatus').innerText = txt;
      await loadDocs();
    } catch (e) {
      el('uploadStatus').innerText = 'Upload failed. Check server logs.';
    } finally {
      el('uploadBtn').disabled = false;
    }
  }

  async function ask() {
    const q = (el('q').value || '').trim();
    if (!q) return;

    el('askBtn').disabled = true;
    el('ans').innerText = 'Thinking...';
    el('src').innerText = '';
    setConfidence(0, true);

    try {
      const r = await fetch('/ask', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ question:q, topK:5 })
      });

      if (!r.ok) {
        const err = await r.text();
        el('ans').innerText = `Error: ${err}`;
        return;
      }

      const j = await r.json();
      el('ans').innerText = j.answer || '';

      setConfidence(j.bestScore, j.weakMatch);

      el('src').innerText = (j.sources||[]).map(s =>
        `score=${(s.score ?? 0).toFixed(3)} file=${s.fileName} page=${s.page ?? 'n/a'} chunk=${s.chunkIndex}\n${s.text}\n`
      ).join('\n---\n');

    } catch (e) {
      el('ans').innerText = 'Ask failed. Check server logs.';
    } finally {
      el('askBtn').disabled = false;
    }
  }

  // init
  (async function init(){
    await health();
    await loadDocs();
    clearAnswer();
  })();
</script>
</body>
</html>
